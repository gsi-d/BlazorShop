@page "/produtos"
@inject IProdutoService produtoService

@if (Produtos == null)
{
    <Spinner />
}
else
{
    <h3 class="mb-5">Produtos</h3>
    @if (Produtos.Count() > 0)
    {
        @foreach (var prodGroup in Produtos)
        {
            <h4>@prodGroup.FirstOrDefault(x => x.CategoriaId == prodGroup.Key).CategoriaNome</h4>
            <div class="row mt-3">
                <ExibirProdutos Produtos="@prodGroup"></ExibirProdutos>
            </div>
        }
    }
}

@code {

    public List<IGrouping<int, ProdutoDTO>>? Produtos { get; set; }
    public string? MensagemErro { get; set; }

    [Inject]
    public ICarrinhoCompraService? CarrinhoCompraService { get; set; }

    [Inject]
    public IGerenciaProdutosLocalStorageService? GerenciaProdutosLocalStorageService { get; set; }
    [Inject]
    public IGerenciaCarrinhoItensLocalStorageService? GerenciaCarrinhoItensLocalStorageService { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LimpaLocalStorage();
            var response = await GerenciaProdutosLocalStorageService.GetCollection();
            Produtos = response.GroupBy(x => x.CategoriaId).OrderBy(x => x.Key).ToList();

            var carrinhoCompraItens = await GerenciaCarrinhoItensLocalStorageService.GetCollection();
            var totalQuantidade = carrinhoCompraItens.Sum(x => x.Quantidade);

            CarrinhoCompraService.RaiseEventOnCarrinhoCompraChanged(totalQuantidade);

        }
        catch (Exception ex)
        {
            MensagemErro = ex.Message;
        }
    }

    private async Task LimpaLocalStorage()
    {
        await GerenciaProdutosLocalStorageService.RemoveCollection();
        await GerenciaCarrinhoItensLocalStorageService.RemoveCollection();
    }

}
